var R=Object.defineProperty;var X=(t,e,n)=>e in t?R(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var h=(t,e,n)=>X(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=n(i);fetch(i.href,l)}})();const f=8,Y={p:1,n:3,b:3,r:5,q:9,k:100},H={b:"♝",q:"♛",r:"♜",k:"♚",p:"♟",n:"♞"},j=`br,bn,bb,bq,bk,bb,bn,br
bp,bp,bp,bp,bp,bp,bp,bp
,,,,,,,
,,,,,,,
,,,,,,,
,,,,,,,
wp,wp,wp,wp,wp,wp,wp,wp
wr,wn,wb,wq,wk,wb,wn,wr`,F=j.split(`
`).map(t=>t.split(","));function Z(t,e,n,s){const i=[];for(let l=-1;l<2;l++)for(let c=-1;c<2;c++)l===0&&c===0||i.push({x:e.x+l,y:e.y+c});return!s&&n==="w"&&t.canWhiteCastleQueenside&&!t.whiteChecked&&t.board[e.y][e.x-1]===""&&t.board[e.y][e.x-2]===""&&t.board[e.y][e.x-3]===""?i.push(...C(t,e,"b","q")):!s&&n==="b"&&t.canBlackCastleQueenside&&!t.blackChecked&&t.board[e.y][e.x-1]===""&&t.board[e.y][e.x-2]===""&&t.board[e.y][e.x-3]===""&&i.push(...C(t,e,"w","q")),!s&&n==="w"&&t.canWhiteCastleKingside&&!t.whiteChecked&&t.board[e.y][e.x+1]===""&&t.board[e.y][e.x+2]===""?i.push(...C(t,e,"b","k")):!s&&n==="b"&&t.canBlackCastleKingside&&!t.blackChecked&&t.board[e.y][e.x+1]===""&&t.board[e.y][e.x+2]===""&&i.push(...C(t,e,"w","k")),i.filter(E).filter(l=>!O(t,l,n))}function C(t,e,n,s){const i=s==="q"?-1:1,l=s==="q"?-2:2;let c=!0;e:for(let a=0;a<f;a++)for(let r=0;r<f;r++){const o=t.board[a][r];if((o==null?void 0:o[0])===n&&V(t,{x:r,y:a},t.board[a][r],!0).some(y=>y.x===e.x+i&&y.y===e.y)){c=!1;break e}}return c?[{x:e.x+l,y:e.y}]:[]}function N(t,e,n){return[{x:e.x+1,y:e.y+2},{x:e.x+2,y:e.y+1},{x:e.x-1,y:e.y+2},{x:e.x-2,y:e.y+1},{x:e.x+1,y:e.y-2},{x:e.x+2,y:e.y-1},{x:e.x-1,y:e.y-2},{x:e.x-2,y:e.y-1}].filter(i=>E(i)).filter(i=>!O(t,i,n))}function z(t,e,n){const s=[],i=n==="w"?[...e.y!==0?[{x:e.x,y:e.y-1}]:[]]:[...e.y!==7?[{x:e.x,y:e.y+1}]:[]];i.length&&!T(t,i[0])&&(n==="w"&&e.y===6?i.push({x:e.x,y:e.y-2}):n==="b"&&e.y===1&&i.push({x:e.x,y:e.y+2}));const l=n==="w"?[{x:e.x-1,y:e.y-1},{x:e.x+1,y:e.y-1}]:[{x:e.x-1,y:e.y+1},{x:e.x+1,y:e.y+1}];return s.push(...i.filter(E).filter(c=>!T(t,c))),s.push(...l.filter(E).filter(c=>{var r,o,d,y;if(n==="w"&&((r=t.blackEnPassant)==null?void 0:r.x)===c.x&&((o=t.blackEnPassant)==null?void 0:o.y)===c.y||n==="b"&&((d=t.whiteEnPassant)==null?void 0:d.x)===c.x&&((y=t.whiteEnPassant)==null?void 0:y.y)===c.y)return!0;const a=t.board[c.y][c.x];return!((a==null?void 0:a[0])===void 0||a[0]===n)})),s}const J=new Array(f).fill(null).map((t,e)=>({x:-e})),S=new Array(f).fill(null).map((t,e)=>({x:+e})),q=new Array(f).fill(null).map((t,e)=>({y:-e})),ee=new Array(f).fill(null).map((t,e)=>({y:+e}));function B(t,e,n){return[...v(t,e,n,J),...v(t,e,n,S),...v(t,e,n,q),...v(t,e,n,ee)]}function te(t,e,n){return[..._(t,e,n),...B(t,e,n)]}const E=t=>t.x<f&&t.x>=0&&t.y<f&&t.y>=0,T=(t,e)=>t.board[e.y][e.x]!=="",O=(t,e,n)=>{const s=t.board[e.y][e.x];return(s==null?void 0:s[0])===n};function K(t,e,n){return V(t,e,n).filter(i=>{const l=new $({...t,onEndTurn:null,onMove:null});return l.move(e,i),l.updateChecked(),n[0]==="w"?!l.whiteChecked:!l.blackChecked})}function V(t,e,n,s){const i=n[0],l=n[1];return l==="p"?z(t,e,i):l==="n"?N(t,e,i):l==="b"?_(t,e,i):l==="r"?B(t,e,i):l==="k"?Z(t,e,i,s):l==="q"?te(t,e,i):[]}function W(t,e){return t===0||t===f-1||e===0||e===f-1}function v(t,e,n,s){const i=[];for(let l of s){if(!l.x&&!l.y)continue;const c={x:e.x+(l.x||0),y:e.y+(l.y||0)};if(!E(c)||O(t,c,n)||(i.push(c),T(t,c)))break}return i}function ne(t){return t>1e4?Math.round(t/100)/10+"k":t}function g(t,e){for(let n=0;n<f;n++)for(let s=0;s<f;s++)if(t.board[n][s]===e)return{x:s,y:n}}const se=new Array(f).fill(null).map((t,e)=>({x:-e,y:-e})),ie=new Array(f).fill(null).map((t,e)=>({x:-e,y:+e})),le=new Array(f).fill(null).map((t,e)=>({x:+e,y:+e})),ce=new Array(f).fill(null).map((t,e)=>({x:+e,y:-e}));function _(t,e,n){return[...v(t,e,n,se),...v(t,e,n,ce),...v(t,e,n,ie),...v(t,e,n,le)]}class ${constructor(e){h(this,"turn",0);h(this,"moves",0);h(this,"result",null);h(this,"canWhiteCastleQueenside",!0);h(this,"canWhiteCastleKingside",!0);h(this,"canBlackCastleQueenside",!0);h(this,"canBlackCastleKingside",!0);h(this,"whiteChecked",!1);h(this,"blackChecked",!1);h(this,"whiteEnPassant",null);h(this,"blackEnPassant",null);h(this,"clickLayer",null);h(this,"piecesElement",null);h(this,"cellsElement",null);h(this,"statusText",null);h(this,"gameMode","cpu");h(this,"onEndTurn",null);h(this,"onMove",null);this.board=e.board.map(n=>[...n]),this.turn=e.turn??0,this.moves=e.moves??0,this.canWhiteCastleQueenside=e.canWhiteCastleQueenside??!0,this.canWhiteCastleKingside=e.canWhiteCastleKingside??!0,this.canBlackCastleQueenside=e.canBlackCastleQueenside??!0,this.canBlackCastleKingside=e.canBlackCastleKingside??!0,this.whiteChecked=e.whiteChecked??!1,this.blackChecked=e.blackChecked??!1,this.whiteEnPassant=e.whiteEnPassant,this.blackEnPassant=e.blackEnPassant,this.onEndTurn=e.onEndTurn,this.onMove=e.onMove}updateChecked(){this.blackChecked=!1,this.whiteChecked=!1;const e=this.turn===0?"w":"b",n=this.turn===0?"b":"w",s=g(this,e+"k");if(!s)return;const i=()=>{e==="b"?this.blackChecked=!0:this.whiteChecked=!0};if(N(this,s,e).some(o=>this.board[o.y][o.x]===n+"n")){i();return}if(_(this,s,e).some(o=>this.board[o.y][o.x]===n+"b"||this.board[o.y][o.x]===n+"q")){i();return}if(B(this,s,e).some(o=>this.board[o.y][o.x]===n+"r"||this.board[o.y][o.x]===n+"q")){i();return}if((e==="b"?[{x:s.x+1,y:s.y+1},{x:s.x-1,y:s.y+1}]:[{x:s.x+1,y:s.y-1},{x:s.x-1,y:s.y-1}]).filter(E).some(o=>this.board[o.y][o.x]===n+"p")){i();return}}move(e,n){var l,c,a,r;const s=this.board[e.y][e.x];if(s==="wk"){const o=n.x-e.x;if(o===2){const d={x:7,y:7};this.move(d,{x:d.x-2,y:d.y})}if(o===-2){const d={x:0,y:7};this.move(d,{x:d.x+3,y:d.y})}this.canWhiteCastleQueenside=!1,this.canWhiteCastleKingside=!1}else if(s==="bk"){const o=n.x-e.x;if(o===2){const d={x:7,y:0};this.move(d,{x:d.x-2,y:d.y})}if(o===-2){const d={x:0,y:0};this.move(d,{x:d.x+3,y:d.y})}this.canBlackCastleQueenside=!1,this.canBlackCastleKingside=!1}s==="wr"?this.canWhiteCastleQueenside&&e.x===0?this.canWhiteCastleQueenside=!1:this.canWhiteCastleKingside&&e.x===7&&(this.canWhiteCastleKingside=!1):s==="br"&&(this.canBlackCastleQueenside&&e.x===0?this.canBlackCastleQueenside=!1:this.canBlackCastleKingside&&e.x===7&&(this.canBlackCastleKingside=!1)),this.board[n.y][n.x]=this.board[e.y][e.x],this.board[e.y][e.x]="";const i=n.y-e.y;s==="wp"&&n.x===((l=this.blackEnPassant)==null?void 0:l.x)&&n.y===((c=this.blackEnPassant)==null?void 0:c.y)?this.board[this.blackEnPassant.y+1][this.blackEnPassant.x]="":s==="bp"&&n.x===((a=this.whiteEnPassant)==null?void 0:a.x)&&n.y===((r=this.whiteEnPassant)==null?void 0:r.y)&&(this.board[this.whiteEnPassant.y-1][this.whiteEnPassant.x]=""),this.blackEnPassant=null,this.whiteEnPassant=null,s==="wp"&&i===-2?this.whiteEnPassant={x:n.x,y:n.y+1}:s==="bp"&&i===2&&(this.blackEnPassant={x:n.x,y:n.y-1}),s==="wp"&&n.y===0?this.board[n.y][n.x]="wq":s==="bp"&&n.y===7&&(this.board[n.y][n.x]="bq"),this.onMove&&this.onMove(e,n)}endTurn(){this.turn=1-this.turn,this.moves++,this.updateChecked(),this.onEndTurn&&this.onEndTurn()}}function G(t,e,n){let s=0;const i=U(t),l=e==="b"?"w":"b";let c=null;for(let a=0;a<f;a++)for(let r=0;r<f;r++){const o={x:r,y:a},d=t.board[a][r];if((d==null?void 0:d[0])===e){const y=d[1],A=W(r,a),D=K(t,o,t.board[a][r]);for(let x of D){const M=W(x.x,x.y);let u=Math.random()*.1;const m=new $({...t,onEndTurn:null,onMove:null});if(m.move(o,x),m.endTurn(),s++,(e==="w"?m.blackChecked:m.whiteChecked)&&(u+=.6),y==="k")x.x-r===2?u+=.6:r-x.x===2?u+=.5:u-=.5;else if(y==="p"){const k=e==="b"?x.y:f-1-x.y;k>4&&(u+=k*.1),(r===3||r===4)&&x.x===r&&(Math.abs(a-x.y)===2?u+=.7:u+=.4)}else y==="n"||y==="b"?(A&&(u+=.5),M&&(u-=.2)):y==="q"?M&&(u-=.2):y==="r"&&M&&(u-=.2);let I;if(n>0){const k=G(m,l,n-1);s+=k.count,k.bestMove?(I=k.bestMove,u-=k.bestMove.value):u+=1e3}const Q=U(m)-i;u+=e==="b"?-Q:Q,(c==null||u>(c==null?void 0:c.value))&&(c={fromSquare:o,toSquare:x,value:u,sub:I})}}}return c&&(t.move(c.fromSquare,c.toSquare),t.endTurn()),{bestMove:c,count:s}}function U(t){return t.board.flat().reduce((e,n)=>n?e+Y[n[1]]*(n[0]==="w"?1:-1):e,0)}const oe=3;class he{constructor(){h(this,"gameState",null);h(this,"clickLayer",null);h(this,"piecesElement",null);h(this,"cellsElement",null);h(this,"statusText",null);h(this,"gameMode","cpu");h(this,"onEndTurn",()=>{if(this.updateStatus(),this.render(),this.cellsElement.querySelectorAll(".check").forEach(e=>e.classList.remove("check")),this.gameState.blackChecked){const e=g(this.gameState,"bk");this.cellsElement.querySelector(`.cell-${e.x}-${e.y}`).classList.add("check")}if(this.gameState.whiteChecked){const e=g(this.gameState,"wk");this.cellsElement.querySelector(`.cell-${e.x}-${e.y}`).classList.add("check")}(this.gameState.turn===1&&this.gameMode==="cpu"||this.gameMode==="cvc")&&this.doCpuMove()});h(this,"onMove",(e,n)=>{var l,c;(l=this.cellsElement.querySelector(".last-move-from"))==null||l.classList.remove("last-move-from"),(c=this.cellsElement.querySelector(".last-move-to"))==null||c.classList.remove("last-move-to"),this.cellsElement.querySelector(`.cell-${e.x}-${e.y}`).classList.add("last-move-from"),this.cellsElement.querySelector(`.cell-${n.x}-${n.y}`).classList.add("last-move-to")});this.clickLayer=document.querySelector("#click-layer"),this.piecesElement=document.querySelector("#pieces"),this.cellsElement=document.querySelector("#cells"),this.statusText=document.querySelector("#status-text"),this.calculationsText=document.querySelector("#calculations"),this.moveText=document.querySelector("#move"),this.oneOnOneButton=document.querySelector("#oneOnOne"),this.cpuButton=document.querySelector("#cpu"),this.cvcButton=document.querySelector("#cvc"),this.oneOnOneButton.addEventListener("click",()=>this.setGameMode("1v1")),this.cpuButton.addEventListener("click",()=>this.setGameMode("cpu")),this.cvcButton.addEventListener("click",()=>this.setGameMode("cvc")),this.setGameMode("cpu")}init(){var e,n;this.gameState=new $({board:F,onEndTurn:this.onEndTurn,onMove:this.onMove}),this.updateStatus(),this.render(),this.calculationsText.innerHTML="&nbsp;",(e=this.cellsElement.querySelector(".last-move-from"))==null||e.classList.remove("last-move-from"),(n=this.cellsElement.querySelector(".last-move-to"))==null||n.classList.remove("last-move-to"),this.cellsElement.querySelectorAll(".check").forEach(s=>s.classList.remove("check")),this.gameMode==="cvc"&&this.doCpuMove()}doCpuMove(){setTimeout(()=>{const e=Date.now(),{count:n,bestMove:s}=G(this.gameState,this.gameState.turn===0?"w":"b",oe);console.log(s),this.calculationsText.textContent=`Evaluated ${ne(n)} positions in ${Math.round((Date.now()-e)/100)/10}s`},100)}render(){this.piecesElement.innerHTML="",this.gameState.board.forEach((e,n)=>{e.forEach((s,i)=>{if(s!==""){const l=document.createElement("div");l.classList.add("piece",s[0]==="w"?"white":"black"),l.style.transform=`translate(${i*50}px, ${n*50}px)`,l.textContent=H[s[1]],this.piecesElement.appendChild(l)}})})}updateStatus(){const e=this.gameState.turn===0?"White":"Black";let n;this.gameMode==="1v1"?n=e+" to move":this.gameMode==="cpu"?n=e+(this.gameState.turn===0?" to move":" thinking..."):n=e+" thinking...",this.statusText.textContent=n,this.moveText.textContent=`Move ${Math.floor(this.gameState.moves/2)+1}`}setGameMode(e){this.gameMode=e,this.init();let n;e==="cpu"?n=this.cpuButton:e==="1v1"?n=this.oneOnOneButton:e==="cvc"&&(n=this.cvcButton),[this.cpuButton,this.oneOnOneButton,this.cvcButton].forEach(s=>s.classList.remove("selected")),n.classList.add("selected")}}const b=new he;for(let t=0;t<f;t++){const e=document.createElement("div");e.classList.add("row"),b.cellsElement.appendChild(e);for(let n=0;n<f;n++){const s=document.createElement("div");s.classList.add("cell",`cell-${n}-${t}`),e.appendChild(s)}}let L=null,p=null,P=null,w=[];const re=(t,e)=>{p&&p.classList.remove("selected"),w.length&&w.forEach(s=>s.classList.remove("valid-move")),w=[],p=b.cellsElement.querySelector(`.cell-${t.x}-${t.y}`),p.classList.add("selected"),L=t,P=e,K(b.gameState,t,e).forEach(s=>{const i=b.cellsElement.querySelector(`.cell-${s.x}-${s.y}`);i.classList.add("valid-move"),w.push(i)})},de=t=>{const e={x:Math.floor(t.offsetX/50),y:Math.floor(t.offsetY/50)},n=b.gameState.board[e.y][e.x];if((n==null?void 0:n[0])===(b.gameState.turn===0?"w":"b")){re(e,n);return}!P||!K(b.gameState,L,P).some(i=>i.x===e.x&&i.y===e.y)||(w.length&&w.forEach(i=>i.classList.remove("valid-move")),b.gameState.move(L,e),P=null,L=null,p.classList.remove("selected"),p=null,b.gameState.endTurn())};b.clickLayer.addEventListener("click",de);
